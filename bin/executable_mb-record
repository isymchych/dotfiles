#!/usr/bin/env bash
set -euo pipefail

screenshots_dir="$HOME/temp/screenshots"
mkdir -p "$screenshots_dir"

usage() {
  echo "usage: mb-record [--region] [--delay seconds|seconds]" >&2
}

mode="screen"
delay_seconds=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --region|-r)
      mode="region"
      shift
      ;;
    --delay|-d)
      if [[ $# -lt 2 ]]; then
        usage
        exit 2
      fi
      delay_seconds="$2"
      shift 2
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      if [[ -z "$delay_seconds" && "$1" =~ ^[0-9]+$ ]]; then
        delay_seconds="$1"
        shift
      else
        usage
        exit 2
      fi
      ;;
  esac
done

delay_seconds="${delay_seconds:-0}"
if [[ ! "$delay_seconds" =~ ^[0-9]+$ ]]; then
  echo "delay_seconds must be a non-negative integer" >&2
  exit 2
fi

timestamp="$(date +%Y%m%d_%H%M%S_%3N)"
outfile="$screenshots_dir/recording_${timestamp}.mp4"

sleep "$delay_seconds"

if [[ "$mode" == "region" ]]; then
  wf-recorder -g "$(slurp)" -f "$outfile"
else
  wf-recorder -f "$outfile"
fi

exit 0
