#!/usr/bin/env bash
set -euo pipefail

screenshots_dir="$HOME/temp/screenshots"
mkdir -p "$screenshots_dir"

if [[ $# -gt 1 ]]; then
  echo "usage: mb-screenshot [delay_seconds]" >&2
  exit 2
fi

delay_seconds="${1:-0}"
if [[ ! "$delay_seconds" =~ ^[0-9]+$ ]]; then
  echo "delay_seconds must be a non-negative integer" >&2
  exit 2
fi

timestamp="$(date +%Y%m%d_%H%M%S_%3N)"
screenshot_outfile="$screenshots_dir/screenshot_${timestamp}.png"

cases="screen
window
part of the screen"

res=$(echo "$cases" | wofi --dmenu)

case "$res" in
    "screen")
        sleep "$delay_seconds"
        grim - | satty -f - -o "$screenshot_outfile"
        ;;
    "window")
        sleep "$delay_seconds"
        grim -g "$(swaymsg -t get_tree | jq -r '.. | select(.focused?) | .rect | "\(.x),\(.y) \(.width)x\(.height)"')" - | satty -f - -o "$screenshot_outfile"
        ;;
    "part of the screen")
        sleep "$delay_seconds"
        grim -g "$(slurp)" - | satty -f - -o "$screenshot_outfile"
        ;;
esac

exit 0
